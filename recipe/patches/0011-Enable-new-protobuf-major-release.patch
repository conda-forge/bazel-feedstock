From 277ae5f8b737a4f83b116822d6978640ac935929 Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Sat, 28 Sep 2024 08:46:03 +0200
Subject: [PATCH 11/12] Enable new protobuf major release

---
 MODULE.bazel                                 | 2 +-
 compile.sh                                   | 4 ++++
 third_party/systemlibs/protobuf/MODULE.bazel | 6 +++---
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/MODULE.bazel b/MODULE.bazel
index e3cd20d8d0..ac42c4bb34 100644
--- a/MODULE.bazel
+++ b/MODULE.bazel
@@ -42,7 +42,7 @@ bazel_dep(name = "apple_support", version = "1.18.1")
 bazel_dep(name = "rules_cc", version = "0.1.1")
 
 # repo_name needs to be used, until WORKSPACE mode is to be supported in bazel_tools
-bazel_dep(name = "protobuf", version = "29.0", repo_name = "com_google_protobuf")
+bazel_dep(name = "protobuf", version = "PROTOC_VERSION", repo_name = "com_google_protobuf")
 local_path_override(
     module_name = "protobuf",
     path = "./third_party/systemlibs/protobuf",
diff --git a/compile.sh b/compile.sh
index bd7a6397bc..7759615ba2 100755
--- a/compile.sh
+++ b/compile.sh
@@ -66,6 +66,10 @@ fi
 
 source scripts/bootstrap/bootstrap.sh
 
+# Make Java code compatible with newer protobuf release now as the bootstrap builds with the old release
+sed -i 's/includingDefaultValueFields/alwaysPrintFieldsWithNoPresence/g' src/main/java/com/google/devtools/build/lib/util/io/MessageOutputStreamWrapper.java
+sed -i 's/includingDefaultValueFields/alwaysPrintFieldsWithNoPresence/g' src/main/java/com/google/devtools/build/lib/worker/JsonWorkerMessageProcessor.java
+
 new_step 'Building Bazel with Bazel'
 display "."
 log "Building output/bazel"
diff --git a/third_party/systemlibs/protobuf/MODULE.bazel b/third_party/systemlibs/protobuf/MODULE.bazel
index 820e74d87b..7e608cd78d 100644
--- a/third_party/systemlibs/protobuf/MODULE.bazel
+++ b/third_party/systemlibs/protobuf/MODULE.bazel
@@ -2,7 +2,7 @@
 # https://github.com/protocolbuffers/protobuf/issues/14313
 module(
     name = "protobuf",
-    version = "27.1", # Automatically updated on release
+    version = "PROTOC_VERSION", # Automatically updated on release
     compatibility_level = 1,
     repo_name = "com_google_protobuf",
 )
@@ -30,8 +30,8 @@ maven_protobuf.install(
     name = "maven_protobuf",
     artifacts = [
         # keep sorted
-        "com.google.protobuf:protobuf-java:3.25.3",
-        "com.google.protobuf:protobuf-java-util:3.25.3",
+        "com.google.protobuf:protobuf-java:PROTOBUF_JAVA_MAJOR_VERSION.PROTOC_VERSION",
+        "com.google.protobuf:protobuf-java-util:PROTOBUF_JAVA_MAJOR_VERSION.PROTOC_VERSION",
     ],
     fail_if_repin_required = False,
     repositories = [
