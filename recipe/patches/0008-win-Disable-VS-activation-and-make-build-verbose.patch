From c4dbcbcaca245a572ecd581c44ad0dede571158c Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Mon, 7 Feb 2022 21:43:56 +0100
Subject: [PATCH 08/12] win: Disable VS activation and make build verbose

---
 src/main/native/windows/build_windows_jni.sh | 24 +++++++++++---------
 1 file changed, 13 insertions(+), 11 deletions(-)

diff --git a/src/main/native/windows/build_windows_jni.sh b/src/main/native/windows/build_windows_jni.sh
index 5d38ffd..e707dd9 100755
--- a/src/main/native/windows/build_windows_jni.sh
+++ b/src/main/native/windows/build_windows_jni.sh
@@ -19,6 +19,8 @@
 # support multiple compilers in the same build yet, so we need to hack around
 # this limitation using a genrule.
 
+set -x
+
 DLL="$1"
 shift 1
 
@@ -36,7 +38,8 @@ fi
 
 # Create a temp directory. It will used for the batch file we generate soon and
 # as the temp directory for CL.EXE .
-VSTEMP=$(mktemp -d)
+VSTEMP=${SRC_DIR}/vstemp
+mkdir -p ${VSTEMP}
 trap "rm -fr \"$VSTEMP\"" EXIT
 VSVARS=""
 
@@ -101,7 +104,7 @@ done
 
 # Copy jni headers to src/main/native folder
 # Mimic genrule //src/main/native:copy_link_jni_md_header and //src/main/native:copy_link_jni_header
-JNI_HEADERS_DIR="${VSTEMP}/src/main/native"
+JNI_HEADERS_DIR="${SRC_DIR}/src/main/native"
 mkdir -p "$JNI_HEADERS_DIR"
 cp -f "$JAVAINCLUDES/jni.h" "$JNI_HEADERS_DIR/"
 cp -f "$JAVAINCLUDES/win32/jni_md.h" "$JNI_HEADERS_DIR/"
@@ -114,15 +117,14 @@ cp -f "$JAVAINCLUDES/win32/jni_md.h" "$JNI_HEADERS_DIR/"
 # directory. See https://github.com/bazelbuild/bazel/issues/3906
 abs_pwd="$(cygpath -a -w "${PWD}")"
 pwd_drive="$(echo "$abs_pwd" | head -c2)"
-cat > "${VSTEMP}/windows_jni.bat" <<EOF
-@echo OFF
-@call "${VSVARS}" amd64
-@$pwd_drive
-@cd "$abs_pwd"
-@set TMP=$(cygpath -a -w "${VSTEMP}")
-@CL /O2 /EHsc /LD /Fe:"$(cygpath -a -w ${DLL})" /I "%TMP%" /I . ${WINDOWS_SOURCES[*]} /link /DEFAULTLIB:advapi32.lib
+cat <<EOF >${SRC_DIR}/windows_jni.bat
+@echo on
+$pwd_drive
+cd "$abs_pwd"
+set TMP=$(cygpath -a -w "${VSTEMP}")
+CL /O2 /EHsc /LD /Fe:"$(cygpath -a -w ${DLL})" /I "%TMP%" /I . ${WINDOWS_SOURCES[*]} /link /DEFAULTLIB:advapi32.lib
 EOF
 
 # Invoke the file and hopefully generate the .DLL .
-chmod +x "${VSTEMP}/windows_jni.bat"
-exec "${VSTEMP}/windows_jni.bat"
+chmod +x "${SRC_DIR}/windows_jni.bat"
+exec "${SRC_DIR}/windows_jni.bat"
