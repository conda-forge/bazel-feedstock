{% set version = "4.2.2" %}

package:
  name: bazel
  version: {{ version }}

source:
  url: https://github.com/bazelbuild/bazel/releases/download/{{ version }}/bazel-{{ version }}-dist.zip
  sha256: 9981d0d53a356c4e87962847750a97c9e8054e460854748006c80f0d7e2b2d33
  patches:
    # TODO: remove again
    #- 0001-Debug-on-win.patch
    - 0001-allow-args-to-be-passed-to-bazel_build.patch
    - 0003-Build-with-native-dependencies.patch   # [unix]
    - 0001-Parametrize-LIBPROTOBUF_VERSION.patch  # [unix]
    - 0004-zipper-from-conda-package.patch        # [build_platform != target_platform]
    - 0005-grpc-java-plugin-build.patch           # [build_platform != target_platform]
    - 0006-bazel-bin-loader-path.patch            # [osx]
    - 0007-link-libprotobuf-grpc-java.patch       # [build_platform == target_platform]
    - 0008-adjust-cross-bazel-resultpath.patch    # [build_platform != target_platform]
    - 0009-Omit-duplicate-codesign.patch          # [osx]

build:
  number: 3
  ignore_prefix_files: true
  binary_relocation: false

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - sed               # [unix]
    - openjdk >=8       # [unix]
    - grpc-cpp          # [unix]
    # Remove this pin again once the java parts of bazel can build with a newer gRPC
    - grpc_java_plugin 1.37  # [osx or (build_platform != target_platform)]
    # - grpc_java_plugin {{ grpc_cpp }}  # [osx or (build_platform != target_platform)]
    - libprotobuf       # [unix]
    - ijar              # [build_platform != target_platform]
    - bazel-toolchain   # [unix]
    - zip  # [linux]
    - unzip  # [linux]
  host:
    - abseil-cpp  # [unix]
    - grpc-cpp  # [unix]
    - libprotobuf  # [unix]
    - openjdk >=8  # [win]
    - posix  # [win]
  run:
    - openjdk >=8
    - posix  # [win]
    - ijar  # [build_platform != target_platform]

test:
  requires:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
  commands:
    - bazel -h
    - bazel version

about:
  home: https://www.bazel.io/
  summary: build system originally authored by Google
  description: |
    Bazel is Google's own build tool, now publicly available in Beta. Bazel has
    built-in support for building both client and server software, including
    client applications for both Android and iOS platforms. It also provides an
    extensible framework that you can use to develop your own build rules.
  dev_url: https://github.com/bazelbuild/bazel
  doc_url: https://www.bazel.io/versions/master/docs/install.html
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE

extra:
  recipe-maintainers:
    - nehaljwani
    - abhi18av
    - jschueller
    - adrianchia
    - xhochy
