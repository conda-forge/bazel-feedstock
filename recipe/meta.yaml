{% set version = "7.2.1" %}
{% set base_url = "https://github.com/bazelbuild/bazel/releases/download" %}

package:
  name: bazel
  version: {{ version }}

source:
  - url: {{ base_url }}/{{ version }}/bazel-{{ version }}-dist.zip
    sha256: dfd823f52fe31328e9e63c27684168b1ab855212b84034c9cd8ccfc7b9af5e0d
    patches:
      ## bazel depends on https://github.com/conda-forge/singlejar-feedstock to build,
      ## which patches the same sources; the patches from singlejar should either be
      ## taken over here, or synced back if change is necessary
      - patches/0001-allow-args-to-be-passed-to-bazel_build.patch
      - patches/0002-Build-with-native-dependencies.patch         # [unix]
      - patches/0003-use-C-17.patch
      - patches/0004-Use-conda-packages-for-build-tools.patch     # [unix]
      - patches/0005-grpc-java-plugin-from-build.patch            # [unix]
      - patches/0006-bazel-bin-loader-path.patch                  # [osx]
      - patches/0007-Adjust-cross-bazel-resultpath.patch
      - patches/0008-win-Disable-VS-activation-and-make-build-verbose.patch
      - patches/0009-Install-protobuf-via-maven.patch             # [unix]
      - patches/0010-Adopt-system-libprotobuf.patch               # [unix]
      - patches/0011-Update-maven_install.json.patch              # [unix]
  - url: {{ base_url }}/{{ version }}/bazel_nojdk-{{ version }}-darwin-x86_64  # [build_platform == "osx-64"]
    sha256: ba0a10ecbdaa70bf348bfdbad2fbcf0ba926a5ee07b613f6656046a1d3f60e07  # [build_platform == "osx-64"]
    fn: bazel  # [build_platform == "osx-64"]
  - url: {{ base_url }}/{{ version }}/bazel_nojdk-{{ version }}-darwin-arm64    # [build_platform == "osx-arm64"]
    sha256: ef15ff2c9ca3cbf2b09dcc88ea6d7d89575cfd6904e560d7691831a1d7daaf82    # [build_platform == "osx-arm64"]
    fn: bazel                                                                   # [build_platform == "osx-arm64"]
  - url: {{ base_url }}/{{ version }}/bazel_nojdk-{{ version }}-linux-x86_64  # [build_platform == "linux-64"]
    sha256: 1c7a167ad2c45374afb19f60093465f58f9209a5142d53d63bc4aadb567323fa  # [build_platform == "linux-64"]
    fn: bazel  # [build_platform == "linux-64"]
  - url: {{ base_url }}/{{ version }}/bazel-{{ version }}-windows-x86_64.exe  # [build_platform == "win-64"]
    sha256: 4926bd3bf580b8b3323e0d09bde5dc6120fdd262d99f753eb61fedfb9a2cfc49  # [build_platform == "win-64"]
    fn: bazel.exe                                                             # [build_platform == "win-64"]

build:
  number: 0
  ignore_prefix_files: true
  binary_relocation: false

requirements:
  build:
    - {{ stdlib('c') }}
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - sed                      # [unix]
    - openjdk >=21             # [unix]
    # we need $BUILD_PREFIX/bin/{grpc_cpp_plugin,grpc_java_plugin,protoc}
    - grpc_java_plugin         # [unix]
    - libgrpc                  # [unix]
    - libprotobuf              # [unix]
    - ijar {{ version }}       # [unix]
    - singlejar {{ version }}  # [unix]
    - bazel-toolchain >=0.2.0  # [unix]
    - zip                      # [linux]
    - unzip                    # [linux]
    - python *                 # [win]
  host:
    - libabseil        # [unix]
    - libgrpc          # [unix]
    - libprotobuf      # [unix]
    - openjdk 21     # [win]
    - posix            # [win]
  run:
    - openjdk >=21
    - posix                    # [win]
    - ijar {{ version }}       # [unix]
    - singlejar {{ version }}  # [unix]

test:
  requires:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - bazel-toolchain >=0.2  # [unix]
  commands:
    - bazel -h
    - bazel version

about:
  home: https://bazel.build/
  summary: a fast, scalable, multi-language and extensible build system
  dev_url: https://github.com/bazelbuild/bazel
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE

extra:
  recipe-maintainers:
    - h-vetinari
    - nehaljwani
    - abhi18av
    - jschueller
    - adrianchia
    - xhochy
